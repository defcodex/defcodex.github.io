---
layout: default
---

<h1>{{ site.title }}</h1>
<p>{{ page.subtitle }}</p>
{{ content }}

{% if site.posts.size > 0 %}
  <style>
    /* Modern counter badge */
    .counter-pill {
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.2rem .5rem; border:1px solid var(--border-color, #e5e7eb);
      border-radius:999px; background:var(--pill-bg, rgba(0,0,0,.04));
      font-size:.8125rem; line-height:1.25rem; margin-left:.5rem;
    }
    .counter-pill svg { width:.95rem; height:.95rem; opacity:.75; flex:0 0 auto; }
    .posts-list { list-style:none; padding-left:0; }
    .posts-list li { margin:.5rem 0; display:flex; align-items:center; gap:.5rem; }
    .posts-list time { color:var(--muted, #6b7280); font-size:.9rem; margin-right:.5rem; white-space:nowrap; }
    @media (prefers-color-scheme: dark) {
      .counter-pill { border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.06); }
    }
  </style>

  <!-- Universal view counter helper with fallback: CountAPI -> hits.sh -->
  <script>
    // Expose a single helper to fetch counters with graceful fallback.
    window.fetchCounter = async function ({ namespace, key }) {
      const fmt = (n) => new Intl.NumberFormat().format(n);

      // Provider 1: CountAPI
      try {
        const url1 = `https://api.countapi.xyz/hit/${encodeURIComponent(namespace)}/${encodeURIComponent(key)}`;
        const r1 = await fetch(url1, { cache: 'no-store' });
        if (r1.ok) {
          const d1 = await r1.json();
          if (typeof d1?.value === 'number') return fmt(d1.value);
        }
      } catch (_) { /* ignore */ }

      // Provider 2: hits.sh (returns { hits: N })
      try {
        const path = `${namespace}/${(key || 'home').replace(/^\/+/, '')}`.replace(/\/+$/, '');
        const url2 = `https://hits.sh/${encodeURIComponent(path)}.json?secure=1`;
        const r2 = await fetch(url2, { cache: 'no-store' });
        if (r2.ok) {
          const d2 = await r2.json();
          if (typeof d2?.hits === 'number') return fmt(d2.hits);
        }
      } catch (_) { /* ignore */ }

      return '—'; // if all fail
    };
  </script>

  <h2>Posts</h2>
  <ul class="posts-list">
    {% for post in site.posts %}
    <li>
      <time datetime="{{ post.date | date_to_xmlschema }}">{{ post.date | date: "%b %d, %Y" }}</time>
      <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
      <!-- per-post view badge -->
      <span class="counter-pill" data-key="{{ post.url }}" title="Views" aria-live="polite">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M1.5 12s3.5-7.5 10.5-7.5S22.5 12 22.5 12s-3.5 7.5-10.5 7.5S1.5 12 1.5 12Z" stroke="currentColor"/>
          <circle cx="12" cy="12" r="3.5" stroke="currentColor" />
        </svg>
        <strong>—</strong>
      </span>
    </li>
    {% endfor %}
  </ul>
  <p><a href="{{ '/rss/' | relative_url }}">Subscribe via RSS</a></p>

  <script>
    (function () {
      // Namespace from _config.yml (fallback to default if missing)
      const ns  = '{{ site.counter.namespace | default: "defcodex.github.io" }}';

      // Normalize Jekyll URLs to avoid duplicate keys (strip trailing slash; "/" -> "home")
      const normalize = (p) => {
        const s = (p || '/').replace(/\/+$/, '');
        return (s === '' || s === '/') ? 'home' : s;
      };

      const pills = document.querySelectorAll('.counter-pill[data-key]');
      if (!pills.length) return;

      // Fetch counters in parallel with fallback
      pills.forEach(pill => {
        const key = normalize(pill.getAttribute('data-key'));
        const strong = pill.querySelector('strong');

        window.fetchCounter({ namespace: ns, key })
          .then(val => { if (strong) strong.textContent = val; });
      });
    })();
  </script>
{% endif %}
